<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>80%</title>

    
    
    
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/eightypercent.css">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-93698-1', 'auto');
      ga('send', 'pageview');

    </script>
    <link rel="icon" type="image/png" href="/images/favicon-assets/favicon@128.png" sizes="128x128" />
    <link rel="icon" type="image/png" href="/images/favicon-assets/favicon@64.png" sizes="64x64" />
    <link rel="icon" type="image/png" href="/images/favicon-assets/favicon@32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="/images/favicon-assets/favicon@16.png" sizes="16x16" />

    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="80%" />
    <link href="/index.xml" rel="feed" type="application/rss+xml" title="80%" />
    
  </head>
  <body>

    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header pull-left">
          <a href="/" class="navbar-brand">80%</a>
        </div>
        <div class="navbar-header navbar-text pull-right">
          Joe Beda &middot; <a href="http://www.twitter.com/jbeda" class="navbar-link" rel="author">@jbeda</a>
        </div>
      </div>
    </nav>

  <div class="container">
    
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/docker-gcplogs.html">Recipe: Docker Logs → Google Stackdriver Logging</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Sun, May 29, 2016</span>
              

<p>Docker logs are a pain to deal with.  If you don&rsquo;t do anything they&rsquo;ll fill up
your disk<sup class="footnote-ref" id="fnref:8c4ec0dc973016a59ed5175b2e089189:docker-log-rotation"><a rel="footnote" href="#fn:8c4ec0dc973016a59ed5175b2e089189:docker-log-rotation">1</a></sup>.  In addition logs are easily lost if you need
to delete and recreate a container.</p>

<p>Google Cloud Platform has a <a href="https://cloud.google.com/logging/docs/">debug log
service</a> that has evolved from the
(excellent) logging system built in to App Engine.  With the acquisition and
integration of Stackdriver it looks like this has been rebranded/merged.</p>

<p>Recently a new <a href="https://docs.docker.com/engine/admin/logging/gcplogs/"><code>gcplogs</code> Docker log
driver</a> was merged (by
<a href="https://github.com/docker/docker/pull/18766">Mike Danese</a>) and it looks like it
is available in Docker 1.11.  Getting it up and working is pretty easy but there
are couple of gotchas.</p>

<h2 id="service-account-scopes:8c4ec0dc973016a59ed5175b2e089189">Service Account Scopes</h2>

<p>First, I did this on a GCE instance that already had the right service account scopes set up.  It <a href="https://developers.google.com/identity/protocols/googlescopes#loggingv2beta1">looks like</a> you need the <code>https://www.googleapis.com/auth/logging.write</code> or <code>https://www.googleapis.com/auth/cloud-platform</code><sup class="footnote-ref" id="fnref:8c4ec0dc973016a59ed5175b2e089189:cloud-platform-scope"><a rel="footnote" href="#fn:8c4ec0dc973016a59ed5175b2e089189:cloud-platform-scope">2</a></sup> scopes.</p>

<p>My instance already had the <code>logging.write</code> scope so I was all set.  I was able to tell by looking at the instance in the cloud console.  Or you can use gcloud (as below).  If you don&rsquo;t see the right scope here you&rsquo;ll need to restart your instance or pretend you aren&rsquo;t on GCE.</p>

<pre><code>$ gcloud compute instances describe --format='yaml(serviceAccounts[].scopes[])' my-instance
serviceAccounts:
- scopes:
  - https://www.googleapis.com/auth/compute
  - https://www.googleapis.com/auth/devstorage.read_write
  - https://www.googleapis.com/auth/logging.write
  - https://www.googleapis.com/auth/userinfo.email
</code></pre>

<p>If you aren&rsquo;t on GCE, you&rsquo;ll want to get a service account key and use that.  I haven&rsquo;t done this but it is documented as part of the Google Cloud <a href="https://developers.google.com/identity/protocols/application-default-credentials#howtheywork">Application Default Credentials</a> system.</p>

<h2 id="activate-the-logging-api:8c4ec0dc973016a59ed5175b2e089189">Activate the Logging API</h2>

<p>You need to &ldquo;enable&rdquo; the logging API before you can use it.  The fact that you
have to manually toggle APIs is probably a historical artifact at GCP.  Just go
<a href="https://console.developers.google.com/apis/api/logging/overview">here</a> and flip
it on.  Make sure you are pointed to the right project.</p>

<p>If you don&rsquo;t do this first you may tickle <a href="https://github.com/docker/docker/issues/21704#issuecomment-222365187">a bug in
Docker/aufs</a>
that will make the container un-deletable.</p>

<h2 id="launch-a-container:8c4ec0dc973016a59ed5175b2e089189">Launch a container</h2>

<p>Now just launch a container and have it log to GCP.</p>

<pre><code>$ docker run -d --name my-container \
  --log-driver=gcplogs \
  --log-opt gcp-log-cmd=true \
  [...]
</code></pre>

<p>You can also set gcplogs as the default for all containers in the daemon but I
haven&rsquo;t tried that yet.</p>

<h2 id="view-logs-on-cloud-console:8c4ec0dc973016a59ed5175b2e089189">View Logs on Cloud Console</h2>

<p>You can now view these logs on the <a href="https://console.cloud.google.com/logs?project=jbeda-personal&amp;service=custom.googleapis.com&amp;key1=&amp;key2=&amp;logName=">cloud
console</a>.
Again, make sure you are pointed at the right project.</p>


<figure >
    <a href="/images/gcp-log-ui.png">
        <img src="/images/gcp-log-ui.png" />
    </a>
    
    <figcaption>
        <h4>Google Cloud Console Logging</h4>
        
    </figcaption>
    
</figure>


<p>To be honest, there is a lot of structure here and the web UI isn&rsquo;t as smooth as
it could be.  You can <em>filter</em> on these fields but you can&rsquo;t control what is
shown.</p>

<p>You can
<a href="https://cloud.google.com/logging/docs/view/advanced_filters#introduction">filter</a>
which events are shown.  This bit is a bit confusing.  It looks like there are 2
filter UIs.  I was using the &ldquo;advanced&rdquo; filter UI that you can get to from the
little down arrow icon to the right of the filter box.  The easiest thing to
filter on is the container name like so:</p>

<pre><code>structPayload.container.name=&quot;/my-container&quot;
</code></pre>

<p>In addition, there is a v1 syntax and a v2 syntax.  I think this box uses the v1
syntax.  It isn&rsquo;t clear how deep the differences are.</p>

<h2 id="view-logs-from-the-command-line:8c4ec0dc973016a59ed5175b2e089189">View logs from the command line</h2>

<p>Because of the lack of control on which fields are show in the log viewer, it is
probably best to view logs from the command line.  Note that this is beta level
in <code>gcloud</code> so the examples here may break in the future.</p>

<p>First, install the beta <code>gcloud</code> tools if you don&rsquo;t already have them.</p>

<pre><code>gcloud components install beta
</code></pre>

<p>Now you can list the logs easily using <a href="https://cloud.google.com/sdk/gcloud/reference/beta/logging/read"><code>gcloud beta logging
read</code></a>.  I
bundled this up into a shell function that is in my <code>.bashrc</code>.</p>

<pre><code class="language-bash">function gcloud-docker-logs {
  local dayago
  if [ $(uname -s) = &quot;Darwin&quot; ]; then
    dayago=$(date -v-1d -u '+%Y-%m-%dT%H:%M:%SZ')
  else
    dayago=$(date  --date=&quot;-1 day&quot; -Isec -u)
  fi

  gcloud beta logging read \
    --order ASC \
    --format='value(timestamp, jsonPayload.data)' \
    &quot;jsonPayload.container.name=\&quot;/$1\&quot; AND timestamp &gt; \&quot;${dayago}\&quot;&quot;
}
</code></pre>

<p>Decoder ring:</p>

<ul>
<li><code>--order ASC</code> makes it look like you are <code>cat</code>ing a log file.</li>
<li><code>--format='value(timestamp, jsonPayload.data)'</code> picks the fields we want to show.  This is just the timestamp and the log line.  For some reason in the web UI this is called <code>structPayload</code> but here it is <code>jsonPayload</code>.  Perhaps this is v1 vs v2 of the API and filter syntax?</li>
<li><code>&quot;jsonPayload.container.name=\&quot;/$1\&quot;&quot;</code> is the filter to apply.  Here we just slap in the name.</li>
<li>We limit this to the last day or logs.  This happens by default when <code>order</code> is set to <code>DESC</code> but we want ascending order.  Because of this we have to explicitly limit the date range.  <code>date</code> is different on BSD systems (MacOS) vs. GNU systems (Linux). Ug.</li>
</ul>

<h2 id="feedback-for-product-groups:8c4ec0dc973016a59ed5175b2e089189">Feedback for product groups</h2>

<ul>
<li>Docker logging should have rotation by default.  The fact that out of the box it fills up your disk is horrible.</li>
<li>I&rsquo;m sad that you still can&rsquo;t change the scopes on a GCE instance while it is running.  This has been in the bug database since scopes were first added.</li>
<li>There is a bunch of structure in that isn&rsquo;t making it into the logging system.  For instance, severity isn&rsquo;t reflected (at least put stderr as WARN?).  It also might be good to hoist the instance name and container name into the primary and secondary keys for logging.  <code>custom.googleapis.com/primary_key: &quot;primary_key&quot;</code> looks like something was left stubbed out.</li>
<li>The logging UI should let you select what to show in addition to filtering the events.  As more structure gets added the simple JSON serialization that is there now won&rsquo;t work.  In addition, that JSON serialization seems to be non-deterministic with respect to field order.</li>
<li><code>gcloud beta logging read</code> should have a &ldquo;follow&rdquo; mode so that you can tail the logs.  This mode exists in the UI.</li>
<li>The GCP logging filter syntax is confusing and inconsistent.  Simple vs advanced. v1 vs v2.</li>
<li>Why am I the one writing this guide? I don&rsquo;t work for Google anymore.</li>
</ul>
<div class="footnotes">

<hr />

<ol>
<li id="fn:8c4ec0dc973016a59ed5175b2e089189:docker-log-rotation">It isn&rsquo;t that hard to set up log rotation but you have to do it.  And after you do, <code>docker logs</code> can&rsquo;t see old logs.  Example on how to do that <a href="https://github.com/jbeda/docker-postfix-forwarder#gotcha-logging">here</a>.
 <a class="footnote-return" href="#fnref:8c4ec0dc973016a59ed5175b2e089189:docker-log-rotation"><sup>[return]</sup></a></li>
<li id="fn:8c4ec0dc973016a59ed5175b2e089189:cloud-platform-scope">This scope is new since from when I worked at Google. I <em>think</em> it is a &ldquo;catch all&rdquo; scope across many GCP services.  Kind of like root.  I can&rsquo;t find any documentation on it specifically.
 <a class="footnote-return" href="#fnref:8c4ec0dc973016a59ed5175b2e089189:cloud-platform-scope"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
          <a class="readmore-click" class="text-center" href="/post/docker-gcplogs.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/eir-at-accel.html">Taking a Leap: Entrepreneur in Residence at Accel</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Wed, Nov 4, 2015</span>
              <p>I’m excited to share that I’m going to be joining Accel as an Entrepreneur in Residence.  I’m honored to be invited to work with Accel to explore ideas that will hopefully result in founding a new company.</p>

<p>I’m committed to staying in Seattle.  While I’ll be traveling down to the Bay Area quite a bit to make the most out of this opportunity with Accel, my heart and family are in Seattle. Seattle has an amazing legacy and talent pool.  The startup community is growing rapidly.  I’m excited to explore joining it as a founder.  In addition, I can be a bit of a bridge for Accel to the unique opportunities that are developing here in the Pacific Northwest.  However, while I plan to stay in Seattle, I’m open to working with strong people wherever they may be based.</p>

<p>So what’s the story behind this move? After 10 years at Google, I went on leave back in February.  I was a bit burned out and my goal was to relax and actually spend time with my family.  After three months on leave, I was having so much fun I decided not to return to work at Google.  My time at Google had been amazing &ndash; both in exposure to amazing technology and amazing people.  I’ve learned an enormous amount and grown both as an engineer and how I view our industry.  Over the summer our family did some traveling together: a camping road trip down the coast and a visit with family in Chicago.  My wife and I also had a chance to celebrate our 15th wedding anniversary with a trip to London together.  I am very fortunate to have been able to take this time off.</p>

<p>As the summer wore on, I knew I’d want to figure out what the next arc of my professional career was going to look like.  To this end, even though I’ve been “funemployed”, I’ve been spending a ton of time meeting all sorts of people from around our industry.  Talking with new people and hearing about what they are building has been invigorating.</p>

<p>One of the people that I’ve had a lot of great conversations with is <a href="http://www.accel.com/team/bay-area/all/ping-li">Ping Li from Accel</a>.  I’ve known Ping now for over a year (time flies!) and I’ve recently started meeting some of the other folks at Accel.  I’ve been impressed with the depth of thought that Accel brings when evaluating opportunities along with the courage to be the first investor in.</p>

<p>My first task is to figure out how to spell “entrepreneur” reliably.  Past that, I’m want to do three things during my time with Accel:</p>

<ul>
<li><strong>Prepare myself for the marathon.</strong> I’ve never built or worked at a startup before.  In this instance, I’m pretty out of the ordinary for an EIR.  But I do know that it is a grueling process with very high highs and very low lows.  I need to make sure that I’m ready.</li>
<li><strong>Find the right co-founders.</strong>  I’ve met lots of great people during my 17+ career in industry.  There are plenty that I’d love to start a company with.  All of them are currently employed.  The EIR is a great way to get started while making sure the timing is right for any co-founders.</li>
<li><strong>Put together a compelling vision.</strong> A technology is not a product and a product is not a business.  While it is possible to start a company without much more than a general direction, that isn’t good enough for me.  I want to have a good coherent vision for how whatever I’m going to do will hang together as a business.  This will take time and research.  I’m planning to tap Accel’s network and portfolio companies to validate ideas and plans.</li>
</ul>

<p>Throughout my career, I’ve continually built platforms.  I like building systems that help others do things that they couldn’t do before.  My recent work to help start the <a href="http://kubernetes.io/">Kubernetes</a> project speaks to this.  There is a good chance that wherever this leads will involve Kubernetes in some capacity.</p>

<p>I’m also taking personal responsibility to make sure that the workplace that I help to craft is empathetic and diverse.  We have huge problems in our industry and I want to do my part to create some sanity.</p>

<p>Wherever this road leads, I’m sure it won’t be dull.  I’ve enjoyed myself most when working with a small team to create something from nothing and I’m really looking forward to doing that again.  If you’d like to chat in depth about this please don’t be afraid to reach out.  I’m active on twitter as <a href="https://twitter.com/jbeda">@jbeda</a>.  I’d be happy to throw ideas around there or over coffee.</p>

          </div>
          <a class="readmore-click" class="text-center" href="/post/eir-at-accel.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/layers-in-the-stack.html">Anatomy of a Modern Production Stack</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Tue, Sep 8, 2015</span>
              <p>(I&rsquo;m updating this post as folks comment.  You can look at the <a href="https://github.com/jbeda/eightypercent/commits/master/content/post/layers-in-the-stack.md">history on github</a>.)</p>

<p>I was chatting on an Xoogler message board the other day and Dennis Ordanov (<a href="https://twitter.com/daodennis">@daodennis</a>) was asking about the basic moving parts of a production stack.  I just started enumerating them from memory and thought it might be a good blog post<sup class="footnote-ref" id="fnref:279eeec6803ac0fbef058e6f7576d2f6:other-posts"><a rel="footnote" href="#fn:279eeec6803ac0fbef058e6f7576d2f6:other-posts">1</a></sup>.  So, here is a mostly stream-of-consciousness dump of the parts a modern (container based) production environment<sup class="footnote-ref" id="fnref:279eeec6803ac0fbef058e6f7576d2f6:caveats"><a rel="footnote" href="#fn:279eeec6803ac0fbef058e6f7576d2f6:caveats">2</a></sup>.</p>

<p><em>A note on the term &ldquo;modern&rdquo;:</em>  This is my view, based on experiences at Google, for a stack that delivers what I&rsquo;d want for a major production system.  You can do this without containers, but I think it is hard to meet my criteria that way.  The full stack here probably isn&rsquo;t necessary for small applications and, as of today, is <strong>way</strong> too hard to get up and running.  The qualities that I&rsquo;d look for in a &ldquo;modern&rdquo; stack:</p>

<ul>
<li><strong>Self healing and self managing.</strong> If a machine fails, I don&rsquo;t want to have to think about it. The system should just work.</li>
<li><strong>Supports microservices.</strong> The idea of breaking your app into smaller components (regardless of the name) can help you to scale your engineering organization by keeping the dev team for each µs small enough that a 2 pizza team can own it.</li>
<li><strong>Efficient.</strong> I want a stack that doesn&rsquo;t require a lot of hand holding to make sure I&rsquo;m not wasting a ton of resources.</li>
<li><strong>Debuggable.</strong> Complex applications can be hard to debug. Having good strategies for application specific monitoring and log collection/aggregation can really help to provide insights into the stack.</li>
</ul>

<p>So, with that, here is a brain dump of the parts that make up a &ldquo;modern&rdquo; stack:</p>

<ul>
<li><strong>Production Host OS</strong>.  This is a simplified and manageable Linux distribution.  Usually it is just enough to get a container engine up and running.<br />

<ul>
<li>Examples include <a href="https://coreos.com/using-coreos/">CoreOS</a>, <a href="http://www.projectatomic.io/">Red Hat Project Atomic</a>, <a href="https://developer.ubuntu.com/en/snappy/">Ubuntu Snappy</a>, and <a href="http://rancher.com/rancher-os/">Rancher OS</a>.</li>
</ul></li>
<li><strong>Bootstrapping system</strong>.  Assuming you are starting with a generic VM image or bare metal hardware, something has to be able to bootstrap those machines and get them running as productive members of the cluster.  This becomes very important as you are dealing with lots machines that come and go as hardware fails.

<ul>
<li><a href="https://bosh.io/docs">Cloud Foundry BOSH</a> was created to do this for Cloud Foundry but is seeing new life as an independent product.</li>
<li>The standard config tools (<a href="https://puppetlabs.com/">Puppet</a>, <a href="https://www.chef.io/">Chef</a>, <a href="http://www.ansible.com/home">Ansible</a>, <a href="http://saltstack.com/">Salt</a>) can serve this role.</li>
<li><a href="https://coreos.com/using-coreos/clustering/">CoreOS Fleet</a> is a lightweight clustering system that can also be used to bootstrap more comprehensive solutions.</li>
</ul></li>
<li><strong>Container Engine</strong>. This is the system for setting up and managing containers.  It is the primary management agent on the node.<br />

<ul>
<li>Examples include <a href="https://www.docker.com/docker-engine">Docker Engine</a>, <a href="https://coreos.com/rkt/docs/latest/">CoreOS rkt</a>, and <a href="https://linuxcontainers.org/">LXC</a> and <a href="http://www.freedesktop.org/software/systemd/man/systemd-nspawn.html">systemd-nspawn</a>.<br /></li>
<li>Some of these systems are more amenable to being directly controlled remotely than others.</li>
<li>The <a href="https://www.opencontainers.org/">Open Container Initiative</a> is working to standardize the input into these systems &ndash; basically the root filesystem for the container along with some common parameters in a JSON file.</li>
</ul></li>
<li><strong>Container Image Packaging and Distribution.</strong> A Container Image is a named and cloneable chroot that can be used to create container instances.  It is pretty much an efficient way to capture, name and distribute the set of files that make up a container at runtime.<br />

<ul>
<li>Both Docker and CoreOS rkt solve this problem.  It is built into the Docker Engine but is broken out for rkt as a separate tool set call <a href="https://github.com/appc/acbuild">acbuild</a>.<br /></li>
<li>Inside of Google this was done slightly differently with a file package distribution system called <a href="https://www.youtube.com/watch?v=_uJlTllziPI">MPM</a>.</li>
<li>Personally, I&rsquo;m hoping that we can define a widely adopted spec for this, hopefully as part of the OCI.</li>
</ul></li>
<li><strong>Container Image Registry/Repository.</strong> This is a central place to store and load Container Images.

<ul>
<li>Hosted versions of this include the <a href="https://hub.docker.com/">Docker Hub</a>, <a href="https://quay.io">Quay.io (owned by CoreOS)</a>, and <a href="https://cloud.google.com/container-registry/">Google Container Registry</a>.</li>
<li>Docker also has an open source registry called <a href="https://github.com/docker/distribution">Docker Distribution</a>.</li>
<li>Personally, I&rsquo;m hoping that the state of the art will evolve past centralized solutions with specialized APIs to solutions that are simpler by working regular HTTP and more transport agnostic so that protocols like BitTorrent can be used to distribute images.</li>
</ul></li>
<li><strong>Container Distribution.</strong> This is the system for structuring what is running inside of a container.  Many people don&rsquo;t talk about this as a separate thing but instead reuse OS distributions such as Ubuntu, Debian, or CentOS.

<ul>
<li>Many folks are working to build minimal container distributions by either using distributions based in the embedded world (BusyBox or Alpine) or by building <a href="https://medium.com/@kelseyhightower/optimizing-docker-images-for-static-binaries-b5696e26eb07">static binaries</a> and not needing anything else.</li>
<li>Personally, I&rsquo;d love to see the idea of a Container Distribution be further developed and take advantage of features only available in the container world.  I wrote a <a href="http://www.eightypercent.net/post/new-container-image-format.html">blog post</a> on this.</li>
</ul></li>
<li><strong>Container Orchestration System.</strong> Once you have containers running on a single host, you need to get them running across multiple hosts.<br />

<ul>
<li>This is a super hot area of interest with lots of innovation.</li>
<li>Open source deployable examples include <a href="http://kubernetes.io/">Kubernetes</a>, <a href="https://docs.docker.com/swarm/">Docker Swarm</a>, and <a href="http://mesos.apache.org/">Apache Mesos</a>.</li>
<li>Hosted systems include <a href="https://cloud.google.com/container-engine/">Google Container Engine (GKE)</a> (based on Kubernetes), <a href="https://mesosphere.com/product/">Mesosphere DCOS</a> and <a href="https://aws.amazon.com/ecs/">Amazon EC2 Container Service (ECS)</a>.  Recently announced is the <a href="https://azure.microsoft.com/en-us/blog/azure-container-service-now-and-the-future/">Microsoft Azure Container Service</a> based on Mesosphere DCOS and Docker Swarm.</li>
</ul></li>
<li><strong>Orchestration Config.</strong> Many of the orchestration systems have small granular objects.  Creating and parameterizing these by hand can be difficult.  In this context, an orchestration config system can take higher level description and compile them down to the nuts and bolts that the orchestration systems works with.

<ul>
<li>The Google solutions to this problem have never been made public (to my knowledge).</li>
<li><a href="https://aws.amazon.com/cloudformation/">AWS CloudFormation</a> and <a href="https://cloud.google.com/deployment-manager/overview">Google Cloud Deployment Manager</a> play this role for their respective cloud ecosystems (only).</li>
<li><a href="https://github.com/hashicorp/terraform">Hashicorp Terraform</a> and <a href="http://flabbergast.org/">Flabbergast</a> look like they could be applied to container orchestration systems but haven&rsquo;t yet.</li>
<li><a href="https://docs.docker.com/compose/">Docker Compose</a> is a start to a more comprehensive config system.</li>
<li>The Kubernetes team (Brian Grant especially) have lots of <a href="https://github.com/kubernetes/kubernetes/labels/area%2Fapp-config-deployment">ideas and plans</a> for this area.  There is a <a href="https://github.com/kubernetes/kubernetes/wiki/Special-Interest-Groups-(SIGs%29">Kubernetes SIG</a> being formed.</li>
</ul></li>
<li><strong>Network Virtualization.</strong> While not strictly necessary, clustered container systems are much easier to use if each container has full presence on the cluster network.  This has been referred to as &ldquo;IP per Container&rdquo;.

<ul>
<li>Without a networking solution, orchestration systems must allocate and enforce port assignment as ports per host are a shared resource.</li>
<li>Examples here include <a href="https://github.com/coreos/flannel">CoreOS Flannel</a>, <a href="http://weave.works/">Weave</a>, <a href="http://www.projectcalico.org/">Project Calico</a>, and <a href="https://github.com/docker/libnetwork">Docker libnetwork</a> (not ready for production yet).  I&rsquo;ve also been pointed to <a href="http://www.opencontrail.org/">OpenContrail</a> but haven&rsquo;t looked deeply.</li>
</ul></li>
<li><strong>Container Storage Systems.</strong> As users move past special &ldquo;pet&rdquo; hosts storage becomes more difficult.

<ul>
<li>I have more to say on this that I&rsquo;ll probably put into a blog post at some point in the future.</li>
<li><a href="https://github.com/clusterhq/flocker">ClusterHQ Flocker</a> deals with migrating data between hosts (among other things).</li>
<li>I know there are other folks (someone pointed me at <a href="http://www.blockbridge.com/">Blockbridge</a>) that are working on software defined storage systems that can work well in this world.</li>
</ul></li>
<li><strong>Discovery Service.</strong> Discovery is a fancy term for naming.  Once you launch a bunch of containers, you need to figure out where they are so you can talk to them.

<ul>
<li>DNS is often used as a solution here but can cause issues in highly dynamic environments due to aggressive caching.  Java, in particular, is troublesome as it <a href="https://www.google.com/search?btnG=1&amp;pws=0&amp;q=networkaddress.cache.ttl+default&amp;gws_rd=ssl">doesn&rsquo;t honor DNS TTLs by default</a>.</li>
<li>Many people build on top of highly consistent stores (lock servers) for this.  Examples include: <a href="https://zookeeper.apache.org/">Apache Zookeeper</a>, <a href="https://coreos.com/etcd/">CoreOS etcd</a>, <a href="https://www.consul.io/">Hashicorp Consul</a>.</li>
<li>Kubernetes supports <a href="https://github.com/kubernetes/kubernetes/blob/master/docs/user-guide/services.md">service definition and discovery</a> (with a stable virtual IP with load balanced proxy).</li>
<li>Weave has a built in <a href="http://blog.weave.works/2015/09/08/weave-gossip-dns/">DNS server</a> that stores data locally so that TTLs can be minimal.</li>
<li>Related is a system to configure wider facing load balancer to manage the interface between the cluster and the wider network.</li>
</ul></li>
<li><strong>Production Identity and Authentication.</strong> As clustered deployments grow, an identity system becomes necessary.  When microservice A calls microservice B, microservice B needs some way to verify that it is actually microservice A calling.  Note that this is for computer to computer communication within the cluster

<ul>
<li>This is not a well understood component of the stack.  I expect it to be an active area of development in the near future.  Ideally the orchestration system would automatically configure the identity for each running container in a secure way.</li>
<li>Related areas include secret storage and authorization.</li>
<li>I&rsquo;ve used the term &ldquo;Authentity&rdquo; to describe this area. Please use it as I&rsquo;m hoping it&rsquo;ll catch on.</li>
<li><a href="http://conjur.net">conjur.net</a> is a commercial offering that can help out in this situation.</li>
</ul></li>
<li><strong>Monitoring.</strong> A modern production application has deep monitoring.  Not only should the operations folks make sure that the binaries continue to run, they should also be monitoring application specific metrics that are thrown off by each microservice that makes up that application.<br />

<ul>
<li>A modern monitoring solution is characterized by its ability to deal with a wide set of metrics along with flexible vector math necessary to do complex aggregations and tests.  Time series data should be sampled frequently (30-60s or less), stored for a long time and be easily explored and graphed.  A good monitoring system not only lets you know when things are down but also is a critical debugging tool to know where and how things are broken.</li>
<li>For open systems, <a href="http://prometheus.io/">Prometheus</a> looks <em>very</em> interesting in this area.<br /></li>
<li>There are also ways to break this apart into smaller parts such as <a href="http://grafana.org/">Grafana</a> as a frontend backed by a dedicated time series database like <a href="https://influxdb.com/">InfluxDB</a> or <a href="http://opentsdb.net/">OpenTSDB</a>. I&rsquo;ve also had multiple people point to <a href="http://graphite.readthedocs.org/en/latest/">Graphite</a> in this space also.</li>
<li><a href="https://github.com/kubernetes/heapster">Heapster</a> is a container specific monitoring system that surfaces data collected by <a href="https://github.com/google/cadvisor">cAdvisor</a>.</li>
<li>There are hosted systems such as <a href="https://cloud.google.com/monitoring/">Google Cloud Monitoring</a> and <a href="https://signalfx.com/">SignalFx</a>.</li>
<li>I&rsquo;m not an expert here so I&rsquo;m sure I&rsquo;m missing some of the awesome stuff going on in this area.</li>
</ul></li>
<li><strong>Logging.</strong> Logging can generally be broken into two types: unstructured debug logs and structured application logs.  The debug logs are used to figure out what is going on with the system while structured logs are usually used to capture important events for later processing and aggregation.  One might use structured logs for ad impressions that are critical for reconciling real money.

<ul>
<li>Systems such as <a href="http://www.fluentd.org/">fluentd</a> and <a href="https://www.elastic.co/products/logstash">logstash</a> are agents that collect and upload logs.</li>
<li>There are a ton of systems for storing and indexing logs.  This includes <a href="https://www.elastic.co/">elasticsearch</a> along with more traditional databases (MySQL, Mongo, etc.).</li>
<li>Hosted systems include <a href="https://cloud.google.com/logging/docs/">Google Cloud Logging</a>.</li>
<li>Logging can also throw off monitoring signals.  For instance, while processing saved logs the local agent can count 500s and feed those into a monitoring system.</li>
<li>Systems like <a href="http://flume.apache.org/">Apache Flume</a><sup class="footnote-ref" id="fnref:279eeec6803ac0fbef058e6f7576d2f6:flume"><a rel="footnote" href="#fn:279eeec6803ac0fbef058e6f7576d2f6:flume">3</a></sup> can be used to collect and reliably save structured logs for processing in the Hadoop ecosystem.  <a href="https://cloud.google.com/bigquery/">Google BigQuery</a> and <a href="https://cloud.google.com/dataflow/">Google Cloud Dataflow</a> are also well suited to ingesting and analyzing structured log data.</li>
</ul></li>
<li><strong>Deep Inspection and Tracing</strong> There are a class of tools that help to do deep debugging.<br />

<ul>
<li>Inside of Google, <a href="http://research.google.com/pubs/pub36356.html">Dapper</a> is a great example of tracing a user request across many microservices.  <a href="https://github.com/sourcegraph/appdash">Appdash</a> and <a href="http://zipkin.io/">Zipkin</a> are open source system inspired by Dapper.</li>
<li>Startups like <a href="http://www.sysdig.org/">Sysdig</a> in this category too by allowing deep inspection and capture of what is going on with a machine.</li>
</ul></li>
</ul>

<p>PaaS systems often help to bring this all together in an easy way.  Systems like <a href="http://www.openshift.org/">OpenShift 3</a>, <a href="http://deis.io/">Deis</a>, or <a href="https://flynn.io">Flynn</a> build on top of some of the independent systems above.  Other PaaS such as <a href="https://www.heroku.com/">Heroku</a>, <a href="https://cloud.google.com/appengine/docs">Google App Engine</a> or <a href="https://www.cloudfoundry.org/">Cloud Foundry</a> are more vertically integrated without the component layers being broken out in a well supported way.</p>

<p>Next on the list would be to talk about continuous integration/continuous deployment (CI/CD) systems and systems for communicating between microservices (RPC and queues). But I think I&rsquo;ll stop here.  If this is useful (or if you think I&rsquo;m missing anything huge) please let me know via <a href="https://www.twitter.com/jbeda">twitter</a>.  Or you can comment on the <a href="https://news.ycombinator.com/item?id=10187598">Hacker News thread</a>.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:279eeec6803ac0fbef058e6f7576d2f6:other-posts"><a href="https://twitter.com/brandonphilips">Brandon Philips</a> from CoreOS points me to a <a href="https://coreos.com/blog/cluster-osi-model/">similar post</a> from <a href="https://twitter.com/barakmich">Barak Michener</a>.  I go into more minutia here and don&rsquo;t try and define a strict stack.
 <a class="footnote-return" href="#fnref:279eeec6803ac0fbef058e6f7576d2f6:other-posts"><sup>[return]</sup></a></li>

<li id="fn:279eeec6803ac0fbef058e6f7576d2f6:caveats"><p>Some caveats:</p>

<ul>
<li>I&rsquo;m sure I&rsquo;m missing some parts of the stack.</li>
<li>The way I break this problem down is based on my experiences at Google. There are many ways to skin this cat.</li>
<li>I&rsquo;ve listed example projects/products/companies/systems at different levels but this isn&rsquo;t meant to be exhaustive.</li>
<li>The fact that I&rsquo;ve listed a system here doesn&rsquo;t mean that I&rsquo;ve run it in production and it has my stamp of approval.</li>
</ul>
 <a class="footnote-return" href="#fnref:279eeec6803ac0fbef058e6f7576d2f6:caveats"><sup>[return]</sup></a></li>
<li id="fn:279eeec6803ac0fbef058e6f7576d2f6:flume">Don&rsquo;t confuse Apache Flume with <a href="http://research.google.com/pubs/pub35650.html">Google FlumeJava</a>.  I guess once you start processing logs some names are just obvious.  Also see <a href="http://research.google.com/archive/sawzall.html">Google Sawzall</a> and <a href="http://research.google.com/pubs/pub36632.html">Google Dremel</a>.
 <a class="footnote-return" href="#fnref:279eeec6803ac0fbef058e6f7576d2f6:flume"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
          <a class="readmore-click" class="text-center" href="/post/layers-in-the-stack.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/types-of-lock-in.html">Operations Lock-in vs. Development Lock-in</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Tue, Sep 1, 2015</span>
              <p>I&rsquo;m not a large enterprise developer.  My experiences are at the unique environments of Google and Microsoft<sup class="footnote-ref" id="fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:exp"><a rel="footnote" href="#fn:9b53a7dde7ddb7e5a1060a94458fa1f8:exp">1</a></sup>.  Over my career I&rsquo;ve helped build <em>platforms</em> and I&rsquo;ve learned that to build a great developer platform (or any good product at all) requires you to talk to many customers and put yourself in their mindset.  This extends from the day to day usability of the product to the decision of a customer to bet a part of his/her business and career on the product in the first place.</p>

<p>Lock-in is obviously one of the critical things that many customers take into account. But lock-in isn&rsquo;t absolute.  Different types of lock-in are defined by the friction and cost incurred in switching.</p>

<p>One interesting way to view lock-in is by looking at who will bear the brunt that switching cost.  You can look at this from the point of view of Ops vs. Dev<sup class="footnote-ref" id="fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:data-lock-in"><a rel="footnote" href="#fn:9b53a7dde7ddb7e5a1060a94458fa1f8:data-lock-in">2</a></sup>.</p>

<ul>
<li>With <strong>Operations Lock-in</strong> the operations team is primarily involved in a migration from one place to another.  The operations playbooks, policies, and procedures may have to change but the code will be substantially unchanged.  Ideally, nothing needs to be recompiled or rebuilt.</li>
<li>With <strong>Developer Lock-in</strong> someone has to actually go in and crack the code.  This could be something minor (swapping in a new library with a standard language interface) to more architectural changes (changing your database).</li>
</ul>

<p>Different organizations have different skill sets and one type of lock-in might be more serious than another.  While someplace like Google or Microsoft may have high quality software engineers to spare, most large enterprises are severly constrained here.  Often <strong>projects were written by developers that are long gone</strong> &ndash; they were independent contractors, left the company, or have moved on to other projects.  In this case developer lock-in can be much more costly than operations lock-in.</p>

<p>Think about it this way &ndash; a user has a large system built on open software packages running on on-prem hardware.  <strong>Switching to a VM/IaaS offering is a relatively cheap project</strong> as it can be an operations focused project with little to no developer involvement.  As IaaS offerings evolved to be more and more similar to real hardware (persistent network block stores, familiar networking) this trend really accelerated.</p>

<p>On the other hand, if a user builds a software product around a very proprietary set of APIs (either language APIs or service APIs) switching can be much more expensive.  Many PaaS offerings would be in this category.  For example, <strong>moving a large application away from AWS Lambda would require a rewrite</strong>.  Google App Engine has similar issues if the native datastore is being used.</p>

<p>This is all critical to keep in mind as we create new ways to build and run systems.  Many times betting on open APIs<sup class="footnote-ref" id="fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:open-apis"><a rel="footnote" href="#fn:9b53a7dde7ddb7e5a1060a94458fa1f8:open-apis">3</a></sup> and open source systems helps to fight lock-in by making switching an operations project vs. a development project.  This is why, despite the eye-rolls, I&rsquo;m excited about the emergance of the <a href="https://www.opencontainers.org/">Open Container Initiative</a> and the <a href="https://cncf.io/">Cloud Native Computing Foundation</a>.</p>

<p>What other ways do you think about lock-in?  Tweet at me (<a href="https://twitter.com/jbeda">@jbeda</a>) and let&rsquo;s start a discussion.</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:9b53a7dde7ddb7e5a1060a94458fa1f8:exp">I started my career on Internet Explorer and moved on to create graphics APIs (including XAML) for Windows Presentation Foundation (WPF).  At Google I started on Google Talk building out <a href="http://xmpp.org/about-xmpp/technology-overview/jingle/">XMPP specifications for call signaling</a> and eventually started Google Compute Engine and helped to start Kubernetes.
 <a class="footnote-return" href="#fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:exp"><sup>[return]</sup></a></li>
<li id="fn:9b53a7dde7ddb7e5a1060a94458fa1f8:data-lock-in">There are, of course, other types of lock-in.  One that is really interesting is data locality lock-in.  As data gets bigger and bigger, simply moving that data around can be complicated and costly.  This gets even more complicated as that data continues to grow while it is being moved.
 <a class="footnote-return" href="#fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:data-lock-in"><sup>[return]</sup></a></li>
<li id="fn:9b53a7dde7ddb7e5a1060a94458fa1f8:open-apis">With the advent of cloud APIs, we&rsquo;ve actually taken a bit of a step back in terms of open APIs.  While there are some companies (<a href="https://twitter.com/stewart/status/634533296555339777">such as Slack</a>) that encourage alternate implementations of their APIs, many companies are silent or hostile to others implementing those APIs.  I&rsquo;d love to see a pattern of companies releasing their APIs with an open license or donating the IP to a foundation. This is made only more critical in light of the <a href="https://en.wikipedia.org/wiki/Oracle_America,_Inc._v._Google,_Inc.">Oracle API copyright decision</a>.
 <a class="footnote-return" href="#fnref:9b53a7dde7ddb7e5a1060a94458fa1f8:open-apis"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
          <a class="readmore-click" class="text-center" href="/post/types-of-lock-in.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/new-container-image-format.html">Container Native Package System</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Wed, Jul 1, 2015</span>
              

<p>A lot of exciting things happened at <a href="http://www.dockercon.com/">Dockercon 2015</a> last week.  For me the most exciting was the announcement of the <a href="http://opencontainers.org/">Open Container Project</a> foundation.  Not only is it great to see the community come together under one banner but also as a chance to entertain new ideas in this space.</p>

<p>These are some thoughts on how to improve what we consider a &ldquo;container image.&rdquo; I&rsquo;m looking at both the container format itself and what goes on inside of it. This obviously builds on ideas in other systems and I&rsquo;ve tried to call those out.  These thoughts are still early so I&rsquo;m hoping to find others of like mind and start a good discussion.</p>

<h2 id="history-and-context:e2f7abed0f5b0c5bd1e697591b3ae6ba">History and Context</h2>

<p>The thing I&rsquo;ve been exploring most recently is the intersection between the container image format and package management.  While there has been plenty of attention on base OSs to host the container (<a href="https://coreos.com/products/">CoreOS</a>, <a href="http://rancher.com/rancher-os/">RancherOS</a>, <a href="http://www.projectatomic.io/">Project Atomic</a>, <a href="https://developer.ubuntu.com/en/snappy/">Snappy Ubuntu</a>) and efforts to coordinate a cluster of hosts (<a href="http://kubernetes.io/">Kubernetes</a>, <a href="https://mesosphere.com/">Mesosphere</a>, <a href="https://www.docker.com/docker-swarm">Docker Swarm</a>) we haven&rsquo;t paid as much attention as we could to what is going on <strong>inside</strong> the container.</p>

<p><strong>Docker Images</strong> are great. Images are pretty efficient to push and pull and, with new focus on security, it is getting easier and easier to be sure that what you want in the image is actually what you are running.</p>

<p><strong>Dockerfiles</strong> are also great.  They are a purpose built makefile analog that are super easy to understand and logically build on the layered nature of Docker images.  Like most of the Docker project, they are much more approachable than other efforts in this area and solve real customer needs. When constructed appropriately, they allow for an efficient dev flow where many of the time consuming steps can be reused.</p>

<p>One of the <strong>best innovations of Docker is actually a bit of an awesome hack</strong>.  It leverages the package managers for existing Linux distributions.  Reusing the package manager means that users can read any number of guides on how to get software installed and easily translate it into a Dockerfile.</p>

<p>Think of it this way: a typical Linux distribution is 2 things. First is a bunch of stuff to get the box booted.  Second is a package manager to install and manage software on that box.  Docker images typically only need the second one.  The first one is along for the ride even if the user never needs it.  There are package managers out there that are cleanly factored from the underlying OS (<a href="http://brew.sh/">Homebrew</a>, <a href="https://nixos.org/nix/">Nix</a>) but they aren&rsquo;t typically used in Docker images.</p>

<h2 id="problems:e2f7abed0f5b0c5bd1e697591b3ae6ba">Problems</h2>

<p>This all mostly works okay.  There is some cruft in the images that can easily be ignored and is &ldquo;cheap&rdquo; as the download and storage cost is amortized because of layer sharing for Docker images.</p>

<p>But we can do better.</p>

<p>Problems with the current state of the world:</p>

<ul>
<li><strong>No package introspection.</strong>  When the next security issue comes along it is difficult to easily see which images are vulnerable.  Furthermore, it is hard to write automated policy to prevent those images from running.</li>
<li><strong>No easy sharing of packages.</strong>  If 2 images install the same package, the bits for that package are downloaded twice.  It isn&rsquo;t uncommon for users to construct complicated &ldquo;inheritence&rdquo; chains to help work around this issue<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:dockerfile-chains"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:dockerfile-chains">1</a></sup>.</li>
<li><strong>No surgical package updating.</strong>  Updating a package requires recreating an image and re-running all downstream actions in the Dockerfile.  If users are good about tracking which sources go into which image<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:tracking-inputs"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:tracking-inputs">2</a></sup>, it should be possible to just update the package but that is difficult and error prone.</li>
<li><strong>Order dependent image builds.</strong> Order matters in a Dockerfile &mdash; even when it doesn&rsquo;t have to.  Often times two actions have zero interaction with each other.  But Docker has no way of knowing that so must assume that every action depends on all preceding actions.</li>

<li><p><strong>Package manager cruft.</strong> Most well built Dockerfiles have something like:</p>

<pre><code>RUN apt-get update \
  &amp;&amp; apt-get install -y --no-install-recommends \
    build-essential \
  &amp;&amp; rm -rf /var/lib/apt/lists/*
</code></pre>

<p>This helps to minimize the size of the layer on disk.  This is confusing boilerplate that is likely just cargo-culted by many users.</p></li>
</ul>

<h2 id="ideas-for-solutions:e2f7abed0f5b0c5bd1e697591b3ae6ba">Ideas for Solutions</h2>

<p>While I don&rsquo;t have a fully formed solution to all of these problems, I do have a bunch of ideas.Imagine that we take the idea of a container image and break it down a little.</p>

<p>The first thing we define is a <code>FileSet</code>.  A <code>FileSet</code> is a named, versioned and verified set of files.  Google has a system internally called the &ldquo;Midas Package Manager&rdquo; (MPM) that does this<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:decentralized-mpm"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:decentralized-mpm">3</a></sup>.  Dinah McNutt gave a <a href="https://www.youtube.com/watch?v=_uJlTllziPI">great talk on MPM</a> at a 2013 USENIX conference.  A further tweak would allow a <code>FileSet</code> to import other <code>FileSet</code>s into the file namespace of the host.  This allows for a <code>FileSet</code> to have multiple &ldquo;parents&rdquo; &ndash; unlike the current Docker layered image format.</p>

<p>Second, we define a <code>Package</code> as a type of <code>FileSet</code>.  It would have a standard directory structure and include metadata on other packages required along with simple instructions to &ldquo;install&rdquo; the package<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:package-install"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:package-install">4</a></sup>. Ideally, these packages would be built from verified sources and a verified tool chain to enable true provenance for every bit. This would be optional.</p>

<p>Finally, we would redefine a <code>ContainerImage</code> also as a type of <code>FileSet</code> that has metadata necessary to make it runnable.  The definition of this metadata is a big part of what the <a href="https://github.com/docker/docker/blob/master/image/spec/v1.md">Docker Image format</a> and the <a href="https://github.com/appc/spec/blob/master/SPEC.md">ACI</a> format are.</p>

<p>A <code>ContainerImage</code> that is using this container native package system would define a set of read-only imports (using the <code>FileSet</code> import feature described above) of all required packages <code>FileSet</code>s.  Image construction tools would verify that all package dependencies are satisfied.  Furthermore, the install steps would be run to symlink<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:symlink-problems"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:symlink-problems">5</a></sup> all of the packages into the appropriate places<sup class="footnote-ref" id="fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:late-symlinking"><a rel="footnote" href="#fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:late-symlinking">6</a></sup>.</p>

<p>User code could either be packed up as a <code>Package</code> or just inserted directly into the <code>ContainerImage</code>.</p>

<h2 id="analysis:e2f7abed0f5b0c5bd1e697591b3ae6ba">Analysis</h2>

<p>By creating a container friendly packaging system and expanding the idea of what an container image is, we can solve most of the issues outlined again.</p>

<ul>
<li>The list of <code>FileSet</code>s imported into, say, <code>/packages</code> would be the list of all packages versions that are included in that image.</li>
<li>Individual <code>FileSet</code>s could be cached by hosts and easily and safely shared between disparate images.</li>
<li>A package could be updated in a straightforward way.  The toolset would have to make sure that all dependencies are satisfied and that the install steps are run as necessary.</li>
<li>Image build tools would list the packages necessary and order wouldn&rsquo;t matter.  Because there are multiple &ldquo;parents&rdquo; to an image, order cannot matter.</li>
<li>The package install cruft (archived version of the package) would be handled on the host side similar to images themselves.  The only thing the container would see would be the actual files &ndash; and they would be symlinked in.</li>
</ul>

<p>There are some missing and underdefined parts to this story.</p>

<ul>
<li><em>How are packages created?</em>  I&rsquo;m thinking that we could do that by running a container with build time packages that produces output file into a specific directory.  Files in that directory are then used to create a package.  As part of this the inputs into the build container could be included in the package metadata and signed.</li>
<li><em>What does a package distribution look like?</em>  I imagine we&rsquo;d have curated sets of packages that are known to work well together.  For instance, xyz.com could create <code>xyz.com/apache</code> that depends on <code>xyz.com/openssl</code>.</li>
<li><em>How do users override packages?</em>  Perhaps <code>abc.com/openssl</code> could specify that it can be used in place of <code>xyz.com/openssl</code>.  Any guarantees by <code>xyz.com</code> would be void but it would be a way to do custom versions and carry patches.</li>
<li><em>Opportunity: Kernel and capability requirements.</em>  Packages could specify their requirements in a way that would be visible to the host.  This would provide a more direct requirement chain between the host and the code running in the container.</li>
</ul>

<p>This solution obviously borrows from both Homebrew and Nix.  What I think is new here is the idea of expanding the definition of an container image with FileSets and making this be fundamentally decentralized.  We also need to ensure that the easy to approach spirit of Dockerfile isn&rsquo;t lost.  If we do this right we can make images much easier to efficiently create, verify, update and manage.</p>

<p>Ping back to me on twitter (<a href="http://www.twitter.com/jbeda">@jbeda</a>) or we can talk over on <a href="https://news.ycombinator.com/item?id=9814131">Hacker News</a></p>

<p>(Thanks to <a href="https://twitter.com/kelseyhightower">Kelsey Hightower</a> for reviewing an earlier version of this post.)</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:dockerfile-chains">The standard golang image is a great example of this.  <code>golang:1.4.2</code> &rarr; <code>buildpack-deps:jessie-scm</code> &rarr; <code>buildpack-deps:jessie-curl</code> &rarr; <code>debian:jessie</code>.  Most of this is done to enable efficient sharing of installed packages.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:dockerfile-chains"><sup>[return]</sup></a></li>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:tracking-inputs">Best practices should be to track every single input into your docker file.  That means that if you are pushing sources you should know which git commit, for example, those sources come from.  My guess is that this is rarely done.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:tracking-inputs"><sup>[return]</sup></a></li>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:decentralized-mpm">Actually, we need our system to be decentralized.  MPM, like may package management systems (including <a href="https://github.com/Homebrew/homebrew/tree/master/Library/Formula">Homebrew</a> and <a href="https://github.com/NixOS/nixpkgs">Nix</a>) has a single central repository/database of all packages.  Whatever is used here must be distributed &mdash; probably in a namespace rooted with DNS.  Something like <a href="https://github.com/docker/notary">Docker Notary</a> would play a role in signing and verifying packages.  Something like the <a href="http://lethalman.blogspot.com/2014/08/nix-pill-9-automatic-runtime.html">Nix archive format (NAR)</a> will help make this more stable and predictable.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:decentralized-mpm"><sup>[return]</sup></a></li>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:package-install">Package install should consist of simply symlinking files into some common directories (<code>/bin</code>, <code>/lib</code>).  This would all be done via a declarative manifest. There are probably going to be cases where an &ldquo;install&rdquo; is a little bit more complex and a script is necessary.  I&rsquo;d love to see how far we could get before that becomes absolutely necessary.  It is also assumed that the package directories themselves are only ever mounted read only.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:package-install"><sup>[return]</sup></a></li>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:symlink-problems">Josh Wood (<a href="https://twitter.com/joshixisjosh9">@joshixisjosh9</a>), <a href="https://twitter.com/joshixisjosh9/status/617008740626116609">via twitter</a>, points out <a href="https://www.usenix.org/legacy/publications/library/proceedings/usenix2000/general/pikelex.html">some issues with using symlinks</a>. An alternative here would be to use bind mounts.  But it is unclear how many bind mounts Linux can handle (100 containers with 100 bind mounts = 10,000 bind mounts) and setting them up requires root privledges.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:symlink-problems"><sup>[return]</sup></a></li>
<li id="fn:e2f7abed0f5b0c5bd1e697591b3ae6ba:late-symlinking">There is a choice on when the package install happens.  It could happen early as the container is created.  Or it could happen late as part of the container start process.  I&rsquo;d prefer late binding as it makes surgical package updating simpler.  The directories that store the symlinks could be tmpfs directories to keep this all very speedy.
 <a class="footnote-return" href="#fnref:e2f7abed0f5b0c5bd1e697591b3ae6ba:late-symlinking"><sup>[return]</sup></a></li>
</ol>
</div>

          </div>
          <a class="readmore-click" class="text-center" href="/post/new-container-image-format.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/relaunch.html">A New Beginning...</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Wed, Jun 10, 2015</span>
              <p>Welcome to the new <a href="http://www.eightypercent.net">80%</a>!</p>

<p>I&rsquo;ve rewritten my ancient blog on top of <a href="http://gohugo.io/">Hugo</a> using <a href="http://getbootstrap.com/">Bootstrap</a> and <a href="https://www.google.com/fonts">Google Fonts</a>.  The whole thing is hosted on <a href="https://github.com/jbeda/eightypercent">GitHub</a> if you want to check out the source.</p>

<p>For headlines, I&rsquo;m using <a href="https://www.google.com/fonts/specimen/Economica">Economica</a>.  I picked it because it is narrow and I tend to write long headlines.  The body text is <a href="https://www.google.com/fonts/specimen/Lora">Lora</a>.  I like a nice Serif font for the body text and it has a bit of style while still being very readable.  Code is in <a href="https://www.google.com/fonts/specimen/Roboto+Mono">Roboto Mono</a> and the Logo and Navigation is in <a href="https://www.google.com/fonts/specimen/Coda">Coda</a>.</p>

<p>I&rsquo;m not in love with the color theme I have now (dark gray background with red and blue highlights) but it&rsquo;ll do for now.  I played with some CSS gradients to show a preview on the main index page.  I&rsquo;m still not sure &ndash; it may be a little too cute.</p>

<p>I&rsquo;ve done the work of importing my old blog posts and making Hugo create compatible URLs.  My original system used XML files for each day so I wrote a <a href="https://github.com/jbeda/eightypercent/blob/master/old-blog/convert.go">short Go program</a> to convert from the XML to something Hugo can consume (markdown files with a JSON header).  I had to introduce a <a href="https://github.com/jbeda/eightypercent/blob/master/layouts/shortcodes/verbatim.html">verbatim HTML shortcode</a> to make Hugo pass through the HTML from the old blog directly.</p>

<p>The other tricky thing was to generate a page per <em>day</em> instead of a page per post for these old posts.  Rolling things up on a daily basis was the way things were done back when I started the blog in <a href="http://new.eightypercent.net/post/old/00001.html">January 2003</a>.  Doing this daily roll up used the <a href="http://gohugo.io/taxonomies/overview/">taxonomy</a> feature of Hugo where the taxonomy was &ldquo;archive&rdquo; and the term was the day.  This was easy to generate from the Go conversion program.</p>

<p>I&rsquo;m hosting this on GCE under Docker and NGINX.  I&rsquo;m going to write up a post on how I&rsquo;m doing that and automatically syncing it to the git repro on each submit.</p>

<p>Now that I have it all set up, we&rsquo;ll see if I actually have anything to say&hellip;</p>

          </div>
          <a class="readmore-click" class="text-center" href="/post/relaunch.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/old/00274.html">HOWTO: Installing Highpoint Rocketraid 222x on Ubuntu Dapper (6.06 LTS)</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Tue, Sep 18, 2007</span>
              

    <p>
        I haven't updated my blog in forever and I'm probably going to abandon my homebrew
        static client generated site for something like <a href="http://mephistoblog.com/">Mephisto</a> at
        some point but I haven't had time to make the transition. 
    </p>
    <p>
        In the meantime, I'd like to save people some pain and document the steps I have go
        through to upgrade my Highpoint RocketRaid 2220 on Linux.&#160; I installed the driver
        a while ago and don't remember the exact steps for that, so this is just what I do
        to upgrade.&#160; I wrote a little shell script: 
    </p>
    <pre>#! /bin/sh -v

# Update this version every time you upgrade.
VER=2.6.15-29-686

# To update the highpoint driver:
# 1) Download latest highpoint driver from: 
#
# http://www.highpoint-tech.com/BIOS_Driver/rr222x/Linux/
#
# 2) Patch driver by changing wrong kernel #ifdefs in osm/linux/os_linux.c  
#   KERNEL_VERSION(2,6,15) -&gt; KERNEL_VERSION(2,6,16)

# Disable sata_mv.ko by moving it to a new directory.  This driver
# conflicts with highpoint driver.  I don't know if this is the
# "right" way to do this, but it works.
sudo mkdir -p /lib/modules/${VER}.disabled
sudo mv /lib/modules/${VER}/kernel/drivers/scsi/sata_mv.ko /lib/modules/${VER}.disabled/

# Make sure kernel headers are installed
sudo apt-get install linux-headers-${VER}

# Make new hpt driver:
cd ~jbeda/sources/rr222x-linux-src-1.07/product/rr2220/linux/
make KERNELDIR=/lib/modules/${VER}/build
sudo make install KERNELDIR=/lib/modules/${VER}/build

# make a new ramfs
# mkinitramfs -o /boot/initrd.img-2.6.15-27-686 /lib/modules/2.6.15-27-686
sudo dpkg-reconfigure linux-image-${VER}</pre>
    <p>
        Good luck. I hope this helps people out there that are stuck with this thing. I'm
        still looking for a good cheap solution to host lots of SATA drives on Linux.&#160;
        Port multipliers are there and aren't as cheap as they should be.&#160; The driver
        situation is pretty dire and there aren't that many non RAID (fake or not) &gt;4 ports
        out there.&#160; I haven't tried any SAS cards though -- perhaps the situation there
        is better.&#160; I'm also running an LSI MegaRAID SATA 300-8XLP with the megaraid
        driver.&#160; It wasn't as cheap but at least it works with a true open driver.&#160; 
    </p>



          </div>
          <a class="readmore-click" class="text-center" href="/post/old/00274.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/old/00273.html">&#34;Avalon marks the end of the American Dream&#34;</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Thu, Aug 3, 2006</span>
              

    <p>
        Miguel de Icaza says <a href="http://tirania.org/blog/archive/2006/Aug-02.html">"Avalon
        marks the end of the American Dream."</a>&#160; He also compares it to J2EE -- apparently
        implying that it is overly complex and overarchitected.
    </p>
    <p>
        Ouch.
    </p>
    <p>
        While I wouldn't put it that way, I can't disagree.&#160; I left Microsoft almost
        two years ago and Avalon still hasn't shipped.&#160; A 5+ year ship cycle for a project
        can't be seen as anything but a sign that something is horribly wrong.&#160; When
        I was on Avalon we kept talking about building an API for the next 10 years.&#160;
        Apparently, when Avalon ships there will be 5 years left on that clock.
    </p>
    <p>
        I take partial responsibility for this.&#160; When we were first starting Avalon,
        I was all about "Go big or go home" and "We should build something only Microsoft
        can build."&#160; In retrospect, the project and the company might have been better
        served by starting with a much smaller team, aiming lower to start and shipping 5
        times over those 5 years.&#160; Version 1 might not have been that impressive, but
        relentless improvement would have built something better factored, simpler, and more
        in tune with what users actually need.
    </p>
    <p>
        I named this blog "eightypercent" in honor of the 80% rule.&#160; It just so happens
        there there are lots of 80% rules to apply.&#160; In this case, a simpler system that
        only solved 80% of the problem would have been good enough and would have shipped
        multiple times already.
    </p>
    <p>
        It looks like the <a href="http://www.google.com/search?hl=en&amp;lr=&amp;q=%22WPF%2FE%22&amp;btnG=Search">WPF/E</a> project
        is an effort to&#160;strip Avalon down to something much more approachable.&#160;
        Cross platform, no full CLR, lower memory footprint -- sounds a lot like Flash/Flex.&#160;
        I know some of the guys working on the project and I have high hopes that it will
        be something interesting.&#160; The only question, when will&#160;it ship?
    </p>



          </div>
          <a class="readmore-click" class="text-center" href="/post/old/00273.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/old/00272.html">Seattle&#39;s Homeless Alcoholics on NPR</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Wed, Jul 19, 2006</span>
              

    <p>
        Coming in this morning, I heard a&#160;<a href="http://www.npr.org/templates/story/story.php?storyId=5567184">segment
        on NPR</a> covering a unique program that King Country is running to provide <a href="http://www.desc.org/1811.html">rooms
        for homeless alcoholics</a> in Seattle.&#160; The unique and controversial part of
        this program is that the residents can continue to drink. 
    </p>
    <p>
        My wife, Rachel, has first hand experience with this problem from her work at the
        Harborview ER.&#160;&#160;Some of these "frequent fliers" are indeed part of the community
        at the ER. In fact, one of the patients that Rachel had lots of interactions with
        (ever since she was a med student!) recently died and it really shook her up.&#160;
        Anecdotally, Rachel has seen this program provide a positive impact. 
    </p>
    <p>
        In any case, this novel program seems to me to be a unique way to approach a very
        difficult problem.&#160; It reduces the cost to the taxpayers and provides a safe
        place for these individuals.&#160; Obviously we would all like to see these problems
        solved, but, failing that, at least the county is trying to manage it. 
    </p>



          </div>
          <a class="readmore-click" class="text-center" href="/post/old/00272.html"></a>
        </div>
      </div>
    </div>
    
    <div class="row">
      <div class="col-sm-offset-2 col-sm-8">
        <h2>
          <span class="glyphicon glyphicon-remove-sign postmark" aria-hidden="true"></span><a href="/post/old/00271.html">1 to 30</a>
        </h2>
        <div class="readmore">
          <div class="post">
              <span class="lead">Fri, Jul 14, 2006</span>
              

    <p>
        Check <a href="http://n.nfshost.com/1.html">this</a> out.&#160; Get to 30.&#160; Your
        day is now shot :) 
    </p>
    <p>
        (I just finished.) 
    </p>



          </div>
          <a class="readmore-click" class="text-center" href="/post/old/00271.html"></a>
        </div>
      </div>
    </div>
    
    

  <nav>
    <ul class="pager">
      <li class="previous disabled">
        <a ><span aria-hidden="true">&larr;</span> Newer</a>
      </li>
      <li class="next">
        <a href="/page/2.html">Older <span aria-hidden="true">&rarr;</span></a>
      </li>
    </ul>
  </nav>

          <footer>
        <nav class="footer navbar-default clearfix container-fluid">
          <div class="row">
            <div class="pull-left navbar-text">
              <span class="text-nowrap">&copy; 2003-2016 Joe Beda</span>
              <span class="text-nowrap"><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" class="navbar-link">CC by-nc-nd 4.0</a></span>
            </div>
            
          </div>
        </nav>
      </footer>

  </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    
    <script src="/js/bootstrap.min.js"></script>
  </body>
</html>


